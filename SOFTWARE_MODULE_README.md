# 软件管理模块说明

## 概述

软件管理模块是 WarpKit 的新增一级菜单功能，用于一键安装和管理常用的 Linux 服务器软件。

## 功能特性

### 1. 宝塔面板管理

#### 未安装状态
- **自动检测**: 自动检测服务器是否已安装宝塔面板
- **安装提示**: 未安装时显示宝塔面板功能介绍和安装确认对话框
- **一键安装**: 使用官方安装脚本进行安装
- **信息保存**: 安装完成后自动提取并保存面板登录信息

#### 已安装状态
- **查看面板信息**: 查看已保存的面板登录信息（地址、用户名、密码等）
- **卸载功能**: 提供完整的卸载流程，包含确认对话框

## 文件结构

```
warpkit/
├── warpkit.sh                          # 主脚本（已更新）
├── modules/
│   └── software.sh                     # 软件管理模块
└── data/
    └── software/                       # 软件数据目录（自动创建）
        ├── baota_panel_info.txt        # 宝塔面板登录信息
        └── baota_install_*.log         # 安装日志
```

## 使用方法

### 方法1: 从主菜单进入
```bash
./warpkit.sh
# 选择 "6. 软件管理" -> "1. 宝塔面板"
```

### 方法2: 直接访问
```bash
./warpkit.sh --software
```

## 宝塔面板安装流程

1. **进入软件管理**: 从主菜单选择 "软件管理"
2. **选择宝塔面板**: 选择 "宝塔面板" 选项
3. **安装确认**:
   - 如果未安装，会显示宝塔功能介绍
   - 提示是否安装 [y/N]
   - 输入 `y` 确认安装
4. **自动安装**:
   - 自动下载官方安装脚本
   - 执行安装过程
   - 保存完整安装日志
5. **信息提取**:
   - 自动从安装输出中提取面板信息
   - 保存到 `data/software/baota_panel_info.txt`
   - 包含：面板地址、用户名、密码、安全入口等

## 安装信息保存格式

安装完成后，面板信息会保存为以下格式：

```
==================================================
宝塔面板登录信息
安装时间: 2025-10-01 12:00:00
==================================================

外网面板地址: http://x.x.x.x:8888/xxxxxxxx
内网面板地址: http://x.x.x.x:8888/xxxxxxxx
username: xxxxxxxx
password: xxxxxxxx
...

==================================================
完整安装日志: /path/to/baota_install_*.log
==================================================
```

## 宝塔面板管理功能

### 已安装状态下的选项

1. **查看面板信息**
   - 显示已保存的登录信息
   - 如果信息文件不存在，会尝试使用 `bt default` 命令获取
   - 显示常用的宝塔管理命令提示

2. **卸载宝塔面板**
   - 显示警告信息
   - 要求用户确认 [y/N]
   - 下载并执行官方卸载脚本
   - 清理保存的面板信息

## 技术实现细节

### 安装脚本
使用宝塔官方安装脚本：
```bash
if [ -f /usr/bin/curl ];then
    curl -sSO https://download.bt.cn/install/install_panel.sh
else
    wget -O install_panel.sh https://download.bt.cn/install/install_panel.sh
fi
bash install_panel.sh ed8484bec
```

### 信息提取
- 使用 `tee` 命令同时显示和保存安装输出
- 使用 `grep` 从日志中提取关键信息
- 提取包含以下关键词的行：
  - 面板地址
  - username
  - password
  - 外网面板
  - 内网面板
  - 安全入口

### 终端状态管理
- 在需要用户输入时恢复终端状态（`restore_terminal_state`）
- 执行完毕后重新设置终端模式（`set_raw_terminal`）
- 确保在交互式选择器和命令行输入之间正确切换

### 数据目录管理
- 优先使用 `$WARPKIT_DIR/data/software`
- 如果无权限，降级使用 `/tmp/warpkit_software_data`
- 自动创建必要的目录结构

## 卸载流程

1. 显示警告信息
2. 用户确认（y/N）
3. 下载官方卸载脚本
4. 执行卸载
5. 清理数据文件

卸载脚本：
```bash
curl -sSO https://download.bt.cn/install/bt-uninstall.sh
bash bt-uninstall.sh
```

## 模块集成

### 主菜单集成
- 在主菜单数组中添加 "软件管理"
- 更新文本菜单选项（1-7）
- 更新选择处理逻辑

### 模块加载系统
- 在 `handle_modular_menu_item` 中添加软件管理处理
- 实现降级策略（模块失败时使用内置版本）
- 添加命令行参数支持 `--software`

### 内置版本
提供简化的内置版本 `show_software_management_builtin`，在模块加载失败时使用。

## 扩展性

模块设计支持未来添加更多软件：

```bash
local software_options=(
    "宝塔面板"
    "其他软件1"  # 预留扩展位置
    "其他软件2"  # 预留扩展位置
    "返回主菜单"
)
```

每个软件可以实现类似的管理流程：
- 安装状态检测
- 安装/卸载功能
- 信息查看
- 配置管理

## 注意事项

1. **权限要求**: 宝塔安装需要 root 权限
2. **网络要求**: 需要能访问宝塔官方服务器
3. **系统兼容**: 支持主流 Linux 发行版
4. **数据保存**: 重要信息会保存到本地，建议定期备份
5. **安装日志**: 保留完整安装日志便于排查问题

## 测试

运行测试脚本验证模块功能：
```bash
bash test_software_module.sh
```

测试项目：
- ✓ 模块文件存在性
- ✓ 模块语法正确性
- ✓ 关键函数完整性
- ✓ 主菜单集成
- ✓ 模块处理逻辑

## 未来计划

可以考虑添加的软件：
- [ ] Docker 快速部署
- [ ] Nginx 管理
- [ ] MySQL/MariaDB 管理
- [ ] PHP 多版本管理
- [ ] Redis 管理
- [ ] 其他常用服务

## 更新日志

### v1.0 (2025-10-01)
- ✓ 初始版本
- ✓ 实现宝塔面板管理功能
- ✓ 集成到主菜单
- ✓ 支持安装/卸载/查看信息
- ✓ 自动提取和保存登录信息
